#!/bin/bash

# Clean up old interfaces (optional)
sudo ip link set br0 down 2>/dev/null
sudo brctl delbr br0 2>/dev/null
sudo ip link delete tap0 2>/dev/null
sudo ip link delete tap1 2>/dev/null

# Create TAP devices
sudo ip tuntap add dev tap0 mode tap
sudo ip tuntap add dev tap1 mode tap
sudo ip link set tap0 up
sudo ip link set tap1 up

# Create bridge
sudo brctl addbr br0
sudo brctl addif br0 tap0
sudo brctl addif br0 tap1
sudo ip addr add 192.168.100.254/24 dev br0
sudo ip link set br0 up

# Enable IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# Detect active outbound interface
OUT_IFACE=$(ip route get 8.8.8.8 | grep -oP 'dev \K\S+')

# Setup NAT
sudo iptables -t nat -F
sudo iptables -t nat -A POSTROUTING -o "$OUT_IFACE" -j MASQUERADE

# Forwarding rules
sudo iptables -A FORWARD -i br0 -o "$OUT_IFACE" -j ACCEPT
sudo iptables -A FORWARD -i "$OUT_IFACE" -o br0 -m state --state RELATED,ESTABLISHED -j ACCEPT
